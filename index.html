
<form id="form" name="form" >
<input type="file" name="image" />
<img src="" id="image">
<label>what to replace prompt</label>
<input type="text" value="only dress" name="mask_detect_prompt" id="mask_detect_prompt" />
<label>replace to prompt</label>
<textarea type="text" value="" name="prompt" id="prompt">fairy tail costume</textarea>
<label>negative prompt</label>
<textarea type="text" value="" name="prompt2" id="negative_prompt">extra legs,(deformed iris, deformed pupils, semi-realistic, cgi, 3d, render, sketch, cartoon, drawing, anime:1.4), text, close up, cropped, out of frame, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, fused fingers, too many fingers, long neck</textarea>
<input type="submit" id="button" value="Generate" />
</form>
<button id="cancel" disabled="true">Cancel job</button>
<div class="timer" id="timer"></div>
<div>
<img width="512" id="result" /></div>

<script>
	var apikey = 'UOM9JEA59ORKWATNUV7WBKZ6LVEXWITF3SLAMZA3'
	var serverid = '1is6op2yolkll0'
	var resizeTo = 0

	const resizeImage = async (
	  url,
	  options = {
	    maxWidth: 1024,
	    maxHeight: 2000,
	    contentType: "image/png",
	    quality: 0.7
	  }
	) => {
	  const calculateSize = (img) => {
	    let w = img.width,
	      h = img.height;
	    if (w > h) {
	      if (w > options.maxWidth) {
	        h = Math.round((h * options.maxWidth) / w);
	        w = options.maxWidth;
	      }
	    } else {
	      if (h > options.maxHeight) {
	        w = Math.round((w * options.maxHeight) / h);
	        h = options.maxHeight;
	      }
	    }
	    return [w, h];
	  };

	  return new Promise((resolve) => {
	    const img = new Image();
	    img.src = url;
	    img.onerror = function () {
	      URL.revokeObjectURL(this.src);
	    };
	    img.onload = function () {
	      URL.revokeObjectURL(this.src);
	      const [newWidth, newHeight] = calculateSize(
	        img,
	        options.maxWidth,
	        options.maxHeight
	      );
	      const canvas = document.createElement("canvas");
	      canvas.width = newWidth;
	      canvas.height = newHeight;
	      const ctx = canvas.getContext("2d");
	      ctx.drawImage(img, 0, 0, newWidth, newHeight);

	      const resultUrl = canvas.toDataURL(options.contentType, options.quality),
	        result = {
	          url: resultUrl,
	          contentType: resultUrl.match(/^data\:([^\;]+)\;base64,/im)[1] || "",
	          b64: resultUrl.replace(/^data\:([^\;]+)\;base64,/gim, "")
	        };

	      canvas.toBlob(
	        (blob) => {
	          result.size = blob.size;
	          resolve(result);
	        },
	        options.contentType,
	        options.quality
	      );
	    };
	  });
	};

	function getBase64(file) {
	  return new Promise((resolve, reject) => {
	    const reader = new FileReader();
	    reader.readAsDataURL(file);
	    reader.onload = () => resolve(reader.result);
	    reader.onerror = error => reject(error);
	  });
	}

	document.querySelector('#cancel').addEventListener('click', e => {
		const url = `https://api.runpod.ai/v2/${serverid}/cancel/${window.currentJobId}`
		fetch(url, {
		  method: 'post',
		  mode: 'cors',
		  headers: new Headers({
		    'Content-Type': 'application/json',
		    'Authorization': `Bearer ${apikey}`
		  })
		})
		document.querySelector('#cancel').setAttribute('disabled', true)
	})

	function setToSecondsToNull() {
		document.querySelector('#timer').innerHTML = "0"
	}

	function updateSeconds() {
		var sec = parseFloat(document.querySelector('#timer').innerHTML)
		sec++;
		document.querySelector('#timer').innerHTML = sec;
	}

	function startTimer() {
		setToSecondsToNull()
		window.currentInterval = setInterval("updateSeconds()", 1000)
	}

	function checkStatus(jobId) {
	  const url = `https://api.runpod.ai/v2/${serverid}/status/${jobId}`
		fetch(url, {
		  method: 'post',
		  mode: 'cors',
		  headers: new Headers({
		    'Content-Type': 'application/json',
		    'Authorization': `Bearer ${apikey}`
		  })
		})
		.then(response => response.json())
		.then(json => {
			if (json.status.toLowerCase() === 'failed') {
				clearInterval(window.currentInterval);
				alert(JSON.stringify(json))
				return
			}
			if (json.output) {
				clearInterval(window.currentInterval);
				document.getElementById('result').src = `data:image/png;base64,${json.output.images[0]}`
			} else {
				setTimeout(() => { checkStatus(jobId) }, 2000);
			}
		})
		.catch((e) => {
			console.error(e)
		})
	}

	setToSecondsToNull()

	document.querySelector('#form').addEventListener('submit', e => {
		document.querySelector('#button').setAttribute('disabled', true)
	  e.preventDefault();

	  const url = `https://api.runpod.ai/v2/${serverid}/runsync`

	  const dataToPost = {
		    "input": {
		        "api": {
		            "method": "pic_replace",
		            "endpoint": "/sam/sam-predict"
		        },
		        "payload": [
		            {
		                "sam_model_name": "sam_vit_h_4b8939.pth",
		                "input_image": "",
		                "sam_positive_points": [],
		                "sam_negative_points": [],
		                "dino_enabled": true,
		                "dino_model_name": "GroundingDINO_SwinT_OGC (694MB)",
		                "dino_text_prompt": document.getElementById('mask_detect_prompt').value,
		                "dino_box_threshold": 0.3,
		                "dino_preview_checkbox": false,
		                "dino_preview_boxes_selection": [
		                    2
		                ]
		            },
		            {
		                "prompt": document.getElementById('prompt').value,
		                "negative_prompt": document.getElementById('negative_prompt').value,
								    "inpainting_fill": 1,
								    "inpaint_full_res": 0,
								    "inpaint_full_res_padding": 32,
								    "inpainting_mask_invert": 0,
								    "include_init_images": true,
								    "initial_noise_multiplier": 1,
								    "script_name": "",
								    "script_args": [],
								    "send_images": true,
								    "save_images": false,
								    "alwayson_scripts": {},
								    "styles": [],
								    "seed": -1,
								    "subseed": -1,
								    "subseed_strength": 0,
								    "seed_resize_from_h": -1,
								    "seed_resize_from_w": -1,
								    "sampler_name": "DPM++ 2M Karras",
								    "extra_generation_params": {"Mask blur": 4},
								    "batch_size": 1,
								    "n_iter": 1,
								    "seed_enable_extras": true,
								    "ddim_discretize": null,
								    "steps": 35,
								    "cfg_scale": 8,
								    "width": 965, 
								    "height": 690, 
								    "restore_faces": false,
								    "tiling": false,
								    "do_not_save_samples": false,
								    "do_not_save_grid": false,
								    "eta": null,
								    "denoising_strength": 0.75,
								    "s_min_uncond": 0,
								    "s_churn": 0,
								    "s_tmax": null,
								    "s_tmin": 0,
								    "s_noise": 1,
								    "sd_model_name": "realisticVisionV51inpaint",
								    "override_settings_restore_afterwards": true,
								    "refiner_switch_at": 0,
								    "disable_extra_networks": false,
								    "comments": {},
								    "resize_mode": 0,
								    "image_cfg_scale": null,
								    "mask_blur_x": 4,
								    "do_not_reload_embeddings": false,
								    "mask_blur_y": 4,
								    "mask_blur": 4
		            }
		        ]
		    }
		}

		startTimer()

		var file = document.querySelector('input[type="file"]').files[0];
		getBase64(file).then(async (data) => {
			let img;
			if (resizeTo > 0) {
				img = await resizeImage(data, {
				  maxWidth: resizeTo
				});
			}

			dataToPost.input.payload[0].input_image = img?.b64 || data;
			
			fetch(url, {
			  method: 'post',
			  body: JSON.stringify(dataToPost),
			  mode: 'cors',
			  headers: new Headers({
			    'Content-Type': 'application/json',
			    'Authorization': `Bearer ${apikey}`
			  })
			})
			.then(response => response.json())
			.then(json => {
				document.querySelector('#button').removeAttribute('disabled')
				
				if (json.output) {
					clearInterval(window.currentInterval);
					document.getElementById('result').src = `data:image/png;base64,${json.output.images[0]}`
				} else {
					document.querySelector('#cancel').removeAttribute('disabled')
					checkStatus(json.id)
				}
			})
			.catch((e) => {

				console.error(e);
				setToSecondsToNull();
			})
		});


	});
</script>